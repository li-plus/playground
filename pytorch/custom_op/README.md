# PyTorch Custom Op

Reference: [[tutorial](https://pytorch.org/tutorials/advanced/cpp_extension.html)] [[code](https://github.com/pytorch/extension-cpp)]

Use [Bear](https://github.com/rizsotto/Bear) to generate compilation database (`compile_commands.json`).

RMSNorm benchmark:
```
Forward:
+------------------------------+------------------+---------------+-------------------+-----------------+---------------------+
| shape                        |   rms_norm_naive |   rms_norm_ts |   rms_norm_triton |   rms_norm_cuda |   speedup vs triton |
|------------------------------+------------------+---------------+-------------------+-----------------+---------------------|
| torch.Size([4, 128, 32])     |           60.303 |        48.126 |           122.539 |          15.247 |               8.037 |
| torch.Size([4, 128, 61])     |           60.756 |        49.628 |           120.907 |          15.387 |               7.858 |
| torch.Size([4, 128, 64])     |           60.187 |        65.137 |           122.853 |          15.938 |               7.708 |
| torch.Size([4, 128, 128])    |           59.951 |        66.585 |           122.470 |          15.097 |               8.112 |
| torch.Size([4, 128, 130])    |           60.259 |        66.261 |           123.391 |          15.488 |               7.967 |
| torch.Size([4, 128, 256])    |           61.340 |        65.849 |           124.181 |          15.611 |               7.955 |
| torch.Size([4, 128, 512])    |           60.622 |        66.041 |           122.194 |          15.489 |               7.889 |
| torch.Size([4, 128, 1024])   |           60.518 |        66.658 |           122.960 |          15.145 |               8.119 |
| torch.Size([4, 128, 1027])   |           60.624 |        66.077 |           122.638 |          15.353 |               7.988 |
| torch.Size([4, 128, 2048])   |           60.245 |        67.382 |           124.231 |          15.311 |               8.114 |
| torch.Size([4, 128, 4096])   |           60.813 |        67.203 |           123.248 |          15.510 |               7.946 |
| torch.Size([4, 128, 8192])   |           85.998 |        94.967 |           120.734 |          22.818 |               5.291 |
| torch.Size([4, 128, 16384])  |          166.899 |       194.797 |           126.394 |          47.671 |               2.651 |
| torch.Size([4, 512, 32])     |           60.273 |        66.746 |           119.328 |          15.176 |               7.863 |
| torch.Size([4, 512, 61])     |           60.890 |        67.623 |           121.448 |          15.404 |               7.884 |
| torch.Size([4, 512, 64])     |           60.451 |        66.827 |           120.495 |          15.753 |               7.649 |
| torch.Size([4, 512, 128])    |           60.241 |        66.278 |           124.873 |          14.905 |               8.378 |
| torch.Size([4, 512, 130])    |           60.737 |        67.771 |           122.321 |          15.631 |               7.825 |
| torch.Size([4, 512, 256])    |           60.498 |        67.232 |           122.985 |          15.415 |               7.978 |
| torch.Size([4, 512, 512])    |           61.511 |        65.664 |           121.122 |          15.500 |               7.814 |
| torch.Size([4, 512, 1024])   |           60.762 |        67.572 |           124.077 |          15.565 |               7.972 |
| torch.Size([4, 512, 1027])   |           60.986 |        66.662 |           121.129 |          15.301 |               7.917 |
| torch.Size([4, 512, 2048])   |           89.442 |        98.507 |           121.546 |          22.706 |               5.353 |
| torch.Size([4, 512, 4096])   |          167.437 |       194.687 |           122.208 |          45.378 |               2.693 |
| torch.Size([4, 512, 8192])   |          313.097 |       372.870 |           120.861 |          83.915 |               1.440 |
| torch.Size([4, 512, 16384])  |          593.907 |       712.727 |           220.510 |         176.207 |               1.251 |
| torch.Size([4, 2048, 32])    |           60.318 |        66.139 |           122.251 |          15.162 |               8.063 |
| torch.Size([4, 2048, 61])    |           60.267 |        66.683 |           121.642 |          15.252 |               7.976 |
| torch.Size([4, 2048, 64])    |           60.570 |        66.735 |           121.601 |          15.173 |               8.014 |
| torch.Size([4, 2048, 128])   |           61.119 |        67.756 |           123.556 |          15.375 |               8.036 |
| torch.Size([4, 2048, 130])   |           61.065 |        67.081 |           122.287 |          15.470 |               7.905 |
| torch.Size([4, 2048, 256])   |           60.804 |        66.897 |           122.759 |          15.142 |               8.107 |
| torch.Size([4, 2048, 512])   |           86.903 |        94.622 |           122.623 |          21.727 |               5.644 |
| torch.Size([4, 2048, 1024])  |          167.324 |       195.530 |           122.220 |          44.217 |               2.764 |
| torch.Size([4, 2048, 1027])  |          170.755 |       198.134 |           124.404 |          49.880 |               2.494 |
| torch.Size([4, 2048, 2048])  |          315.285 |       377.164 |           124.241 |          82.221 |               1.511 |
| torch.Size([4, 2048, 4096])  |          604.169 |       725.693 |           161.834 |         161.275 |               1.003 |
| torch.Size([4, 2048, 8192])  |         1158.542 |      1395.546 |           420.225 |         317.814 |               1.322 |
| torch.Size([4, 2048, 16384]) |         2288.298 |      2757.762 |           869.986 |         698.676 |               1.245 |
+------------------------------+------------------+---------------+-------------------+-----------------+---------------------+
Backward:
+------------------------------+------------------+---------------+-------------------+-----------------+---------------------+
| shape                        |   rms_norm_naive |   rms_norm_ts |   rms_norm_triton |   rms_norm_cuda |   speedup vs triton |
|------------------------------+------------------+---------------+-------------------+-----------------+---------------------|
| torch.Size([4, 128, 32])     |          170.702 |       176.509 |           163.543 |          68.805 |               2.377 |
| torch.Size([4, 128, 61])     |          176.798 |       114.272 |           167.458 |          70.054 |               2.390 |
| torch.Size([4, 128, 64])     |          176.376 |       120.507 |           170.563 |          75.125 |               2.270 |
| torch.Size([4, 128, 128])    |          176.465 |       133.013 |           169.458 |          68.991 |               2.456 |
| torch.Size([4, 128, 130])    |          173.895 |       136.203 |           169.522 |          72.647 |               2.333 |
| torch.Size([4, 128, 256])    |          195.568 |       137.919 |           170.316 |          70.056 |               2.431 |
| torch.Size([4, 128, 512])    |          176.025 |       138.941 |           166.545 |          70.518 |               2.362 |
| torch.Size([4, 128, 1024])   |          172.101 |       133.388 |           168.460 |          70.239 |               2.398 |
| torch.Size([4, 128, 1027])   |          243.894 |       151.728 |           244.725 |          98.471 |               2.485 |
| torch.Size([4, 128, 2048])   |          175.339 |       134.471 |           173.929 |          73.014 |               2.382 |
| torch.Size([4, 128, 4096])   |          174.920 |       157.799 |           172.131 |          70.721 |               2.434 |
| torch.Size([4, 128, 8192])   |          307.797 |       202.911 |           145.077 |         104.221 |               1.392 |
| torch.Size([4, 128, 16384])  |          595.667 |       375.834 |           210.413 |         187.563 |               1.122 |
| torch.Size([4, 512, 32])     |          172.869 |       135.544 |           165.118 |          69.144 |               2.388 |
| torch.Size([4, 512, 61])     |          173.607 |       139.791 |           165.206 |          68.925 |               2.397 |
| torch.Size([4, 512, 64])     |          181.494 |       163.514 |           171.421 |          72.696 |               2.358 |
| torch.Size([4, 512, 128])    |          180.991 |       140.283 |           168.603 |          73.376 |               2.298 |
| torch.Size([4, 512, 130])    |          203.881 |       138.976 |           166.292 |          73.304 |               2.269 |
| torch.Size([4, 512, 256])    |          177.990 |       144.417 |           168.915 |          72.661 |               2.325 |
| torch.Size([4, 512, 512])    |          184.278 |       140.378 |           167.949 |          74.489 |               2.255 |
| torch.Size([4, 512, 1024])   |          178.809 |       143.501 |           165.582 |          73.472 |               2.254 |
| torch.Size([4, 512, 1027])   |          175.622 |       138.043 |           166.650 |          72.255 |               2.306 |
| torch.Size([4, 512, 2048])   |          304.190 |       202.116 |           166.015 |          99.102 |               1.675 |
| torch.Size([4, 512, 4096])   |          600.322 |       376.855 |           209.033 |         183.804 |               1.137 |
| torch.Size([4, 512, 8192])   |         1103.938 |       705.162 |           383.097 |         335.071 |               1.143 |
| torch.Size([4, 512, 16384])  |         2112.155 |      1351.143 |           784.185 |         684.648 |               1.145 |
| torch.Size([4, 2048, 32])    |          176.652 |       148.414 |           165.428 |          72.849 |               2.271 |
| torch.Size([4, 2048, 61])    |          180.954 |       147.997 |           166.247 |          73.162 |               2.272 |
| torch.Size([4, 2048, 64])    |          178.296 |       152.299 |           166.805 |          73.982 |               2.255 |
| torch.Size([4, 2048, 128])   |          182.352 |       152.684 |           167.754 |          74.335 |               2.257 |
| torch.Size([4, 2048, 130])   |          179.987 |       152.022 |           172.552 |          74.658 |               2.311 |
| torch.Size([4, 2048, 256])   |          177.601 |       151.265 |           174.138 |          72.227 |               2.411 |
| torch.Size([4, 2048, 512])   |          309.846 |       205.697 |           166.640 |         105.170 |               1.584 |
| torch.Size([4, 2048, 1024])  |          603.653 |       383.611 |           203.419 |         183.308 |               1.110 |
| torch.Size([4, 2048, 1027])  |          607.445 |       385.928 |           195.696 |         190.155 |               1.029 |
| torch.Size([4, 2048, 2048])  |         1115.204 |       715.847 |           390.134 |         340.153 |               1.147 |
| torch.Size([4, 2048, 4096])  |         2134.049 |      1365.623 |           784.721 |         655.497 |               1.197 |
| torch.Size([4, 2048, 8192])  |         4139.525 |      2639.327 |          1491.789 |        1243.603 |               1.200 |
| torch.Size([4, 2048, 16384]) |         8173.746 |      5224.144 |          3061.391 |        2665.393 |               1.149 |
+------------------------------+------------------+---------------+-------------------+-----------------+---------------------+
```

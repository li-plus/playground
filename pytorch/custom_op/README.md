# PyTorch Custom Op

Reference: [[tutorial](https://pytorch.org/tutorials/advanced/cpp_extension.html)] [[code](https://github.com/pytorch/extension-cpp)]

Use [Bear](https://github.com/rizsotto/Bear) to generate compilation database (`compile_commands.json`).

RMSNorm benchmark:
```
Forward:
+-----------------------------+------------------+---------------+-------------------+-----------------+
| shape                       |   rms_norm_naive |   rms_norm_ts |   rms_norm_triton |   rms_norm_cuda |
|-----------------------------+------------------+---------------+-------------------+-----------------|
| torch.Size([4, 128, 32])    |           59.519 |        48.043 |           124.156 |          15.222 |
| torch.Size([4, 128, 61])    |           60.962 |        49.526 |           121.075 |          14.999 |
| torch.Size([4, 128, 64])    |           59.838 |        65.124 |           121.546 |          15.684 |
| torch.Size([4, 128, 128])   |           59.707 |        79.772 |           121.467 |          15.058 |
| torch.Size([4, 128, 131])   |           60.124 |        65.839 |           122.811 |          15.144 |
| torch.Size([4, 128, 256])   |           60.415 |        65.099 |           120.855 |          15.141 |
| torch.Size([4, 128, 512])   |           59.835 |        67.145 |           128.741 |          15.493 |
| torch.Size([4, 128, 1024])  |           62.017 |        67.238 |           121.408 |          15.625 |
| torch.Size([4, 128, 1027])  |           60.203 |        66.450 |           121.371 |          16.105 |
| torch.Size([4, 128, 2048])  |           59.931 |        67.409 |           123.979 |          15.497 |
| torch.Size([4, 128, 4096])  |           60.732 |        67.843 |           121.082 |          16.013 |
| torch.Size([4, 512, 32])    |           59.818 |        65.778 |           119.868 |          15.956 |
| torch.Size([4, 512, 61])    |           60.565 |        67.002 |           121.097 |          15.130 |
| torch.Size([4, 512, 64])    |           60.191 |        65.960 |           135.284 |          15.781 |
| torch.Size([4, 512, 128])   |           62.043 |        66.983 |           122.197 |          14.720 |
| torch.Size([4, 512, 131])   |           60.445 |        65.793 |           121.670 |          15.224 |
| torch.Size([4, 512, 256])   |           60.989 |        69.529 |           122.159 |          15.374 |
| torch.Size([4, 512, 512])   |           60.549 |        66.487 |           122.482 |          15.847 |
| torch.Size([4, 512, 1024])  |           78.361 |        66.720 |           125.039 |          15.536 |
| torch.Size([4, 512, 1027])  |           60.656 |        67.558 |           122.202 |          15.359 |
| torch.Size([4, 512, 2048])  |           89.126 |        98.307 |           123.774 |          22.954 |
| torch.Size([4, 512, 4096])  |          167.689 |       194.786 |           126.241 |          46.213 |
| torch.Size([4, 2048, 32])   |           60.437 |        67.270 |           120.499 |          15.822 |
| torch.Size([4, 2048, 61])   |           60.982 |        67.027 |           121.609 |          15.192 |
| torch.Size([4, 2048, 64])   |           60.617 |        66.002 |           121.275 |          15.393 |
| torch.Size([4, 2048, 128])  |           60.884 |        67.216 |           120.484 |          15.115 |
| torch.Size([4, 2048, 131])  |           61.331 |        66.406 |           122.666 |          15.604 |
| torch.Size([4, 2048, 256])  |           60.354 |        66.968 |           133.229 |          15.384 |
| torch.Size([4, 2048, 512])  |           85.875 |        94.562 |           120.267 |          21.877 |
| torch.Size([4, 2048, 1024]) |          167.586 |       195.484 |           120.878 |          43.942 |
| torch.Size([4, 2048, 1027]) |          170.743 |       198.165 |           124.320 |          50.050 |
| torch.Size([4, 2048, 2048]) |          315.675 |       376.280 |           123.241 |          82.678 |
| torch.Size([4, 2048, 4096]) |          602.989 |       724.933 |           162.552 |         162.133 |
+-----------------------------+------------------+---------------+-------------------+-----------------+
Backward:
+-----------------------------+------------------+---------------+-------------------+-----------------+
| shape                       |   rms_norm_naive |   rms_norm_ts |   rms_norm_triton |   rms_norm_cuda |
|-----------------------------+------------------+---------------+-------------------+-----------------|
| torch.Size([4, 128, 32])    |          171.982 |       179.256 |           165.206 |          70.109 |
| torch.Size([4, 128, 61])    |          180.952 |       115.379 |           166.047 |          72.561 |
| torch.Size([4, 128, 64])    |          173.447 |       115.515 |           166.975 |          70.192 |
| torch.Size([4, 128, 128])   |          172.898 |       131.370 |           165.662 |          72.244 |
| torch.Size([4, 128, 131])   |          176.629 |       136.396 |           169.952 |          74.352 |
| torch.Size([4, 128, 256])   |          175.364 |       135.741 |           164.455 |          69.939 |
| torch.Size([4, 128, 512])   |          173.368 |       141.227 |           172.221 |          70.693 |
| torch.Size([4, 128, 1024])  |          172.982 |       136.221 |           169.801 |          71.180 |
| torch.Size([4, 128, 1027])  |          178.462 |       137.486 |           167.525 |          71.309 |
| torch.Size([4, 128, 2048])  |          177.969 |       134.077 |           165.248 |          69.149 |
| torch.Size([4, 128, 4096])  |          174.645 |       137.704 |           169.484 |          70.913 |
| torch.Size([4, 512, 32])    |          174.478 |       135.358 |           166.280 |          69.298 |
| torch.Size([4, 512, 61])    |          176.183 |       140.118 |           167.094 |          70.981 |
| torch.Size([4, 512, 64])    |          180.162 |       147.192 |           165.118 |          75.555 |
| torch.Size([4, 512, 128])   |          181.435 |       140.141 |           163.313 |          75.483 |
| torch.Size([4, 512, 131])   |          174.467 |       135.928 |           165.124 |          70.237 |
| torch.Size([4, 512, 256])   |          180.693 |       140.322 |           165.355 |          74.559 |
| torch.Size([4, 512, 512])   |          180.382 |       139.234 |           166.175 |          74.450 |
| torch.Size([4, 512, 1024])  |          189.446 |       146.618 |           167.934 |          75.680 |
| torch.Size([4, 512, 1027])  |          182.415 |       141.375 |           165.661 |          72.594 |
| torch.Size([4, 512, 2048])  |          305.170 |       201.520 |           193.032 |          99.246 |
| torch.Size([4, 512, 4096])  |          600.391 |       377.369 |           208.872 |         184.181 |
| torch.Size([4, 2048, 32])   |          176.313 |       148.575 |           170.600 |          73.478 |
| torch.Size([4, 2048, 61])   |          179.203 |       146.687 |           171.167 |          76.056 |
| torch.Size([4, 2048, 64])   |          180.482 |       153.288 |           172.844 |          80.904 |
| torch.Size([4, 2048, 128])  |          179.738 |       149.585 |           164.319 |          72.630 |
| torch.Size([4, 2048, 131])  |          184.303 |       158.335 |           181.778 |          74.868 |
| torch.Size([4, 2048, 256])  |          181.272 |       155.710 |           169.432 |          72.744 |
| torch.Size([4, 2048, 512])  |          311.235 |       204.957 |           175.809 |         104.892 |
| torch.Size([4, 2048, 1024]) |          603.903 |       383.678 |           203.059 |         184.601 |
| torch.Size([4, 2048, 1027]) |          607.604 |       386.393 |           196.235 |         188.498 |
| torch.Size([4, 2048, 2048]) |         1115.031 |       715.710 |           390.398 |         340.638 |
| torch.Size([4, 2048, 4096]) |         2134.366 |      1364.778 |           789.090 |         655.839 |
+-----------------------------+------------------+---------------+-------------------+-----------------+
```
